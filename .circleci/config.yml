version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.9

    environment:
      LOG_FILE_LOCATION: /tmp/test_results
      GOPATH: /home/ubuntu/.go_workspace
      IMPORT_PATH: github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME

    working-directory: $GOPATH/src/github.com/joedevs/dockerci
    general:
      build_dir: ../.go_workspace/src/$IMPORT_PATH
    steps:
      - checkout
      - run: mkdir -p $LOG_FILE_LOCATION
      - restore_cache: # restores saved cache if no changes are detected since last run
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          keys:
            - v1-pkg-cache
      - run: go get -u github.com/golang/dep/cmd/dep
      - run:
          name: run build
          command: |
            dep ensure
            go build -v
      - run:
          name: run tests
          command: |
            go fmt ./...
            go vet ./...
            go test -v ./...

      - save_cache: # Store cache in the /go/pkg directory
                key: v1-pkg-cache
                paths:
                  - "/go/pkg"
      - store_artifacts: # Upload test summary for display in Artifacts: https://circleci.com/docs/2.0/artifacts/
          path: /tmp/test-results
          destination: raw-test-output
      - store_test_results:
          path: /tmp/test-results